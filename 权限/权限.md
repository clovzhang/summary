## 前提条件

1.登录：在用户完成登录之后，也就是调用了**登录接口**，例如`/api/login`。

​	当用户填写完账号和密码后向服务端验证是否正确，验证通过之后，服务端会返回一个**token**，拿到token之后（我会将这个token存贮到cookie中，保证刷新页面后能记住用户登录状态），前端会根据token再去拉取一个 **user_info** 的接口来获取用户的详细信息（如用户权限，用户名等等信息）。

2.权限验证：在根据用户的token在去调用一个**获取数据权限的接口**，例如`/api/permission`。

​	前端会有一份路由表，它表示了每一份路由可访问的权限，当用户登录之后，通过token获取用户对应的 **role**，动态根据用户的 role 算出其对应有权限的路由，通过 **router.addRoutes** 动态挂载这些路由。

这个接口会返回给我当前用户他的角色下的所有权限编码，例如

```javascript
[
	"000011110001",
	"000011110002",
	"000011110003",
	"000011110004",
	"000011110005",
]
```

我在拿到这个数组之后，会把它保存在全局store里面，例如命名为**roles**



## 路由权限控制

路由控制主要是控制当前用户能看到那些页面。

它的主要实现是用到了动态路由功能。

在前端路由配置中，会有两个数组：

- `constantRouterMap`：基础路由，一些固定的路由页面
- `asyncRouterMap`：动态路由，一些不确定的路由页面

固定的路由页面就是表示任何人会有的页面，例如：dashbord页面

不确定的路由页面，也就是动态页面（涉及权限的页面）

例如有一个页面的配置如下：

```javascript
{
	path: 'home',
  name: 'home',
  component: () => import('@/views/home/index'),
  meta: {  permission: [ '000011110001' ] },
}
```



## 具体按钮的权限

具体按钮的权限用到了`vue`中的`directive`指令，它允许我们自定义指令。

设计一个权限的指令：

**src/permission.js**

```javascript
import Store from '@/store/index'
export const permission = {
  bind (el, binding, vnode) {
    const roles = Store.state.roles
    const { value } = binding
    if (value && value instanceof Array && value.length > 0) {
      const permissionRoles = value
      const hasPermission = roles.some(role => {
        return permissionRoles.includes(role)
      })
      if (!hasPermission) {
        el.parentNode && el.parentNode.removeChild(el) || (el.style.display = 'none')
      }
      console.log('el.parentNode', el.parentNode)
    } else {
      throw new Error('need permission! Like v-permission="[\'admin\',\'editor\']"')
    }
  }
}

```

在页面上具体控制一个按钮：

```javascript
<a-button v-permission='["admin"]' @click="goBatch()">按钮</a-button>
```

如果业务较复杂，在v-permission不支持的情况，可使用全局的计算属性的方法，在js中或者复杂组件中使用。

```javascript
import { mapGetters } from 'vuex'
<complex-component v-if='hasPermission(["test"])'>复杂组件</complex-component>
export default {
  computed: {
    ...mapGetters({
      hasPermission: 'permission/hasPermission'
    })
	}
}

```



## 参照

[权限验证](https://panjiachen.github.io/vue-element-admin-site/zh/guide/essentials/permission.html#%E9%80%BB%E8%BE%91%E4%BF%AE%E6%94%B9](https://panjiachen.github.io/vue-element-admin-site/zh/guide/essentials/permission.html#逻辑修改))
[数据权限如何控制](https://github.com/LinDaiDai/niubility-coding-js/blob/master/other/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6.md)